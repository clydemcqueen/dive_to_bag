# Generate a ROS2 Bag from ArduSub Logs

These tools can be used to create ROS2 bags from dive logs, including:
* Dataflash (BIN) files
* MAVLink telemetry (tlog) files
* Video (mp4) files

The general process looks like this:
* Examine the logs and select the files to process
* Figure out the time-shift values to use for BIN and MP4 files
* Generate bags, one bag per log or video
* Use `ros2 bag convert` to merge the bags into a single bag

## Requirements

Tested on Ubuntu 22.04 with ROS2 Humble.

Several scripts rely on transforms3d. There are 2 ways to install transforms3d, depending on your situation.

Method 1: install transforms3d-0.3.1 on Ubuntu 22.04 via apt:
~~~
sudo apt install python3-transforms3d
~~~

Version 0.3.1 depends on numpy version < 1.20. If you already installed a newer version of numpy via pip you
will get an error along the lines of `AttributeError: module 'numpy' has no attribute 'float'.`
If that happens, you'll have use method 2.

Method 2: install transforms3d-0.4.2 via pip:
~~~
# If you installed the older version using apt, remove it, then:
pip install transforms3d
~~~

## Tools

### [df_to_bag](df_to_bag.py)

Read a single dataflash log (BIN file) and write sensor messages to a bag. These messages are converted:
* `IMU` to `sensor_msgs::msg::Imu` on topics `/imu0`, `/imu1`, ...
* `MAG` to `sensor_msgs::msg::MagneticField` on topics `/mag0`, `/mag1`, ...

Usage:
~~~
usage: df_to_bag.py [-h] [--out OUT] [--boot BOOT] in_path

Read a dataflash log (BIN file) and write the IMU and MAG messages to a ROS2 bag.

positional arguments:
  in_path

options:
  -h, --help   show this help message and exit
  --out OUT    output bag path
  --boot BOOT  boot time, default is 0
~~~

#### A note on time:

This tool uses the mavutil-provided `_timestamp` attribute to get message time. The `_timestamp` attribute contains
UNIX Epoch time _iff_ there is a GPS message in the log with a valid time, otherwise it contains time-since-boot.
(Note that the WL UGPS extension does not provide valid time.) In this case, you can set the `--boot` value to
set the boot time in the UNIX Epoch.

TL;DR If your bags seem to start on January 1st, 1970, then you need to provide a `--boot` option.

The best source of information for `--boot` is a [SYSTEM_TIME](https://mavlink.io/en/messages/common.html#SYSTEM_TIME)
message from a tlog file, which contains 2 fields:
* `time_unix_usec` -- this will the Raspberry Pi time, which _should be_ in UNIX Epoch time -- check it!
* `time_boot_ms` -- this is time-since-boot

A good value for `--boot` is `SYSTEM_TIME.time_unix_usec - SYSTEM_TIME.time_boot_ms * 1e3`.

### [tlog_to_bag](tlog_to_bag.py)

Read a single telemetry log (tlog file) and write sensor messages to a bag. These messages are converted:
* `GPS_INPUT` to `sensor_msgs::msg::NavSatFix` on topics `/gps0`, `/gps1`, ...
* `VISION_POSITION_DELTA` to `geometry_msgs::msg::TwistStamped` on topic `/dvl`

Usage:
~~~
usage: tlog_to_bag.py [-h] [--out OUT] [--origin ORIGIN] [--start START] in_path

Read a MAVLink telemetry log (tlog file) and write the GPS and DVL messages to a ROS2 bag.

positional arguments:
  in_path

options:
  -h, --help       show this help message and exit
  --out OUT        output bag path
  --origin ORIGIN  map frame origin, form: lat,lon
  --start START    skip to start time
~~~

### [video_to_bag](video_to_bag.py)

Open a video (anything that OpenCV can open, including mp4) and write images to a bag.

Usage:
~~~
usage: video_to_bag.py [-h] [--out OUT] [--start START] [--topic TOPIC] [--frame_id FRAME_ID] [--width WIDTH] [--height HEIGHT] [--mono] [--max MAX] in_path

Use OpenCV to open a video file and write image messages to a ROS2 bag.

positional arguments:
  in_path

options:
  -h, --help           show this help message and exit
  --out OUT            output bag path
  --start START        video start time, default is 0
  --topic TOPIC        topic, default is "image_raw"
  --frame_id FRAME_ID  camera frame_id, default is "camera_frame"
  --width WIDTH        scale width
  --height HEIGHT      scale height
  --mono               convert to monochrome
  --max MAX            maximum number of frames to read
~~~

#### A note on time:

You'll need to provide the timestamp for the 1st image in the UNIX Epoch.

### [wl_ugps_csv_to_bag](wl_ugps_csv_to_bag.py)

Read the csv files generated by wl_ugps_external_extension and create a bag with sensor data and transforms.

Usage:
~~~
usage: wl_ugps_csv_to_bag.py [-h] [--acoustic-bias ACOUSTIC_BIAS] path gga_filename hdt_filename acoustic_filename

Read the csv files generated by wl_ugps_external_extension and create a bag with sensor data and transforms.

Coordinate frames and transform tree:
    map -- world frame, origin is the 1st GGA message
        vessel -- pose of the GNSS compass, from GGA and HDT logs
            antenna -- pose of the WL UGPS antenna (not provided by this script)
                acoustic -- pose of the ROV, from g2_acoustic log

You must provide a static transform vessel -> antenna, e.g.,
    ros2 run tf2_ros static_transform_publisher 1.57 -1.273 -0.377 0 0 0 vessel antenna

positional arguments:
  path
  gga_filename
  hdt_filename
  acoustic_filename

options:
  -h, --help            show this help message and exit
  --acoustic-bias ACOUSTIC_BIAS
~~~
